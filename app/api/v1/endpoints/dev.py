# backend/app/api/v1/endpoints/dev.py
import asyncio
import json
import re
import time
from fastapi import APIRouter, Depends
from fastapi.responses import StreamingResponse
from pydantic import BaseModel
from typing import List, Dict, Any, AsyncGenerator, Optional
import sqlite3
from app.database import get_db_connection
from app.db_init import init_db
import logging

router = APIRouter()
logger = logging.getLogger(__name__)

# --- Mock Data for /write mode ---

MOCK_ELABORATION = {
    "elaboration": {
        "summary": "一篇关于“世界发展格局”的深度分析文章，旨在探讨其历史演变、当前特征、主要驱动力以及未来趋势。",
        "style": "学术严谨，客观中立，数据驱动。",
        "strategy": "首先定义核心概念，然后分点论述主要趋势，接着通过案例研究进行具体分析，最后进行总结与展望。"
    }
}

MOCK_OUTLINE = {
    "plan": [
        {"sub_goal": "第一章：引言：变革时代的全球图景", "steps": [
            {"sub_goal": "1.1: “世界发展格局”的核心内涵", "steps": [
                {"sub_goal": "1.1.1: 概念界定与维度解析"},
                {"sub_goal": "1.1.2: 历史脉络中的格局演变"}
            ]},
            {"sub_goal": "1.2: 研究当前格局的时代意义"}
        ]},
        {"sub_goal": "第二章：多重力量交织下的主要趋势", "steps": [
            {"sub_goal": "2.1: 全球化浪潮的深刻变奏", "steps": [
                {"sub_goal": "2.1.1: 从超级全球化到选择性全球化"},
                {"sub_goal": "2.1.2: 供应链重构与区域化崛起"}
            ]},
            {"sub_goal": "2.2: 地缘政治的断层与重组", "steps": [
                {"sub_goal": "2.2.1: 大国战略竞争的全面化"},
                {"sub_goal": "2.2.2: “中间地带”国家的战略自主"}
            ]},
            {"sub_goal": "2.3: 全球经济增长的结构性困境", "steps": [
                {"sub_goal": "2.3.1: 债务周期与货币政策转向"},
                {"sub_goal": "2.3.2: 数字鸿沟与财富分配不均"}
            ]}
        ]},
        {"sub_goal": "第三章：关键领域的变革驱动力", "steps": [
            {"sub_goal": "3.1: 科技革命：重塑竞争边界", "steps": [
                {"sub_goal": "3.1.1: 人工智能与生物技术的战略价值"},
                {"sub_goal": "3.1.2: 技术标准与数字治理的博弈"}
            ]},
            {"sub_goal": "3.2: 能源转型：绿色议程下的地缘经济", "steps": [
                {"sub_goal": "3.2.1: 清洁能源供应链的竞争"},
                {"sub_goal": "3.2.2: 传统能源地缘政治的变迁"}
            ]},
            {"sub_goal": "3.3: 意识形态与文化叙事的力量"}
        ]},
        {"sub_goal": "第四章：典型案例深度剖析", "steps": [
            {"sub_goal": "4.1: 案例一：亚洲的群体性崛起与内部整合"},
            {"sub_goal": "4.2: 案例二：欧洲一体化的挑战与韧性"},
            {"sub_goal": "4.3: 案例三：“全球南方”的诉求与行动"}
        ]},
        {"sub_goal": "第五章：未来展望与战略应对", "steps": [
            {"sub_goal": "5.1: 未来格局演变的三种情景推演"},
            {"sub_goal": "5.2: 全球治理体系的改革方向"},
            {"sub_goal": "5.3: 结论：在不确定性中航行"}
        ]}
    ]
}

MOCK_CHAPTER_STRATEGIES = {
    "第一章：引言：变革时代的全球图景": {"strategy": "本章旨在为全文奠定理论和时代背景。首先清晰界定“世界发展格局”的多维概念，然后简要回顾其历史演变，最后突出在当前“百年未有之大变局”下研究该主题的紧迫性和重要性，为全文设定基调。"},
    "第二章：多重力量交织下的主要趋势": {"strategy": "本章是文章的核心分析部分，将从全球化、地缘政治和经济三个宏观维度，系统论述当前世界发展格局的主要动态特征。每个小节都应包含对趋势的描述、对其背后驱动力的分析，以及对其深远影响的评估，展现格局的复杂性。"},
    "第三章：关键领域的变革驱动力": {"strategy": "本章将聚焦于塑造未来格局的关键变量。选取科技、能源和文化三个最具代表性的领域，深入探讨它们如何成为大国博弈的新前沿，并重塑传统的国际竞争规则与力量对比。"},
    "第四章：典型案例深度剖析": {"strategy": "本章通过具体案例使理论分析更具实证性。选取亚洲、欧洲和“全球南方”三个具有代表性的行为体进行剖析，展示不同力量在全球格局中的角色、挑战与战略选择，增强文章的说服力。"},
    "第五章：未来展望与战略应对": {"strategy": "本章负责总结全文并提出前瞻性思考。首先基于前文分析，构建未来格局演变的几种可能情景。然后探讨全球治理体系改革的必要性与方向，最后以一个开放性的结论收尾，强调在不确定性时代中保持战略清醒和灵活应对的重要性。"}
}

MOCK_SECTION_CONTENT = {
    "概念界定与维度解析": {"content": "世界发展格局，在国际关系理论中，通常指一个特定历史时期内，全球主要行为体（包括国家、国际组织、跨国公司等）在多个维度上的力量分布、相互关系及互动模式所形成的宏观战略态势。这个概念是动态且多维的，其核心维度包括：政治与军事力量的分布，决定了国际安全秩序的基本形态；经济与科技实力，构成了国家竞争力的基础；以及文化与制度影响力，即所谓的“软实力”，在全球治理和规则制定中扮演着日益重要的角色。理解世界发展格局，就是要把握这些维度上的力量对比、主要矛盾和互动规则的总体特征及其演变趋势。"},
    "历史脉络中的格局演变": {"content": "现代世界发展格局的演变，大致可追溯至威斯特伐利亚体系确立后的欧洲多极均势。工业革命与殖民扩张打破了这一均势，最终在两次世界大战后形成了以美苏为首的两极对峙格局。这一时期，世界被清晰地划分为两大阵营，意识形态对抗主导了国际关系。随着1991年苏联解体，冷战结束，世界进入了由美国主导的“一超多强”时期，全球化加速发展。然而，进入21世纪，特别是2008年全球金融危机之后，以中国为代表的新兴经济体群体性崛起，俄罗斯的战略复苏，以及地区强国的日益活跃，共同推动世界格局向着一个更加复杂、多元化的新多极化时代加速过渡。"},
    "研究当前格局的时代意义": {"content": "在当前这个被广泛认为是“百年未有之大变局”的时代，深入研究世界发展格局具有前所未有的紧迫性和重要性。首先，它有助于我们理解大国战略竞争的根源、表现形式和未来走向，为国家制定外交与安全政策提供认知基础。其次，全球性挑战日益严峻，如气候变化、大规模流行病、网络安全等，任何单一国家都无法独立应对，理解并适应新的发展格局是推动全球治理体系改革、构建有效多边合作机制的前提。最后，对于企业和个人而言，把握世界发展格局的宏观趋势，有助于在跨国投资、技术创新和职业发展中做出更明智的决策，规避风险，抓住机遇。"},
    "从超级全球化到选择性全球化": {"content": "冷战结束后至2008年金融危机前，世界经历了一个“超级全球化”时期，其特点是贸易壁垒大幅降低、资本自由流动、跨国公司主导的全球产业链深度整合。然而，金融危机暴露了其内在的脆弱性，叠加近年来地缘政治竞争加剧、新冠疫情冲击等因素，全球化正进入一个新的阶段，可称之为“选择性全球化”或“集团化全球化”。其特征表现为，各国不再无差别地拥抱开放，而是更加强调供应链的“安全”与“韧性”，在核心技术、关键矿产等战略领域推动“友岸外包”和“近岸外包”，形成了以价值观和安全考量为界限的平行或半脱钩的经济循环。"},
    "供应链重构与区域化崛起": {"content": "作为选择性全球化的直接后果，全球供应链正在经历一场深刻的结构性重构。过去以效率为唯一导向的“即时生产”（Just-in-Time）模式，正被兼顾安全与效率的“以防万一”（Just-in-Case）模式所取代。这推动了生产网络的区域化集聚，例如《区域全面经济伙伴关系协定》（RCEP）在东亚的深化、北美自由贸易区的升级以及欧盟推动的“战略自主”。这种区域化趋势一方面增强了地区经济的内生动力，另一方面也可能加剧不同经济集团之间的壁垒和摩擦，对世界贸易组织的权威构成挑战。"},
    "大国战略竞争的全面化": {"content": "当前世界发展格局最显著的特征之一，是中美之间战略竞争的长期化和全面化。这场竞争已超越传统的军事和经济领域，扩展到技术标准、金融体系、网络空间、外太空乃至全球治理规则制定等各个方面。双方都在努力构建各自的联盟体系和伙伴关系网络，试图在关键议题上主导国际议程。这种全面的竞争态势深刻地影响着其他国家的战略选择，迫使它们在不同程度上进行“选边站队”或寻求战略对冲，从而重塑了全球的政治与安全版图。"},
    "“中间地带”国家的战略自主": {"content": "在大国竞争加剧的背景下，广大的“中间地带”国家，包括欧洲、东南亚、中东、拉美和非洲的主要国家，其战略自主意识普遍增强。它们不愿被动卷入大国对抗，而是试图利用自身的地理位置、市场规模或资源禀赋，在多个大国之间寻求平衡，实现自身利益的最大化。这种“战略自主”的追求，使得国际关系变得更加复杂和多维，也为全球格局的演变增添了更多的变量和不确定性。这些国家的集体选择，将在很大程度上决定未来世界是走向分裂对抗还是合作共赢。"},
    "债务周期与货币政策转向": {"content": "经历了长期的低利率和量化宽松环境后，全球正面临一个历史性的债务高企周期。新冠疫情期间的大规模财政刺激进一步推高了各国政府和企业的杠杆率。为应对通货膨胀，主要发达经济体央行被迫采取激进的加息政策，导致全球流动性收紧，融资成本急剧上升。这不仅对高负债国家构成了严峻的主权债务违约风险，也抑制了全球的投资和消费需求，给世界经济复苏蒙上了厚重的阴影。各国货币政策的分化也加剧了国际资本流动的波动性和汇率风险。"},
    "数字鸿沟与财富分配不均": {"content": "尽管数字经济蓬勃发展，但全球范围内的数字鸿沟依然巨大。在国家之间，发达国家与发展中国家在数字基础设施、技术普及和数据利用能力上存在显著差距。在一国内部，不同地区、不同社会群体之间也存在着数字接入和数字技能的不平等。这种不平等与传统的财富分配不均问题相互叠加，进一步加剧了社会分化。少数科技巨头掌握了海量数据和核心算法，形成了新的垄断，其财富积累速度远超传统行业，这已成为全球性的经济和社会治理难题。"},
    "人工智能与生物技术的战略价值": {"content": "人工智能（AI）和生物技术作为第四次工业革命的核心驱动力，其战略价值已超越纯粹的经济层面，成为大国博弈的制高点。AI不仅在改变军事作战的模式（如自主武器系统），还在重塑情报搜集与分析、社会舆论引导等国家安全领域。生物技术，特别是在基因编辑、合成生物学和脑机接口等前沿领域，不仅关系到国民健康和粮食安全，更可能在未来改变人类自身的能力边界。因此，各国都在加大对这两大领域的研发投入，争夺技术制高点、人才和数据资源，其竞争结果将深刻影响未来的国力对比。"},
    "技术标准与数字治理的博弈": {"content": "随着新技术的普及，围绕技术标准和数字治理规则的国际博弈日趋激烈。谁能主导5G、人工智能、物联网等关键领域的技术标准制定，谁就能在全球产业链中占据优势地位。同时，关于数据跨境流动、个人隐私保护、平台责任、网络主权等数字治理议题，不同国家和地区提出了截然不同的理念和方案，例如欧盟的《通用数据保护条例》（GDPR）、美国的市场驱动模式以及中国的数据安全法规。这场围绕规则和标准的竞争，实质上是未来数字世界秩序主导权的争夺。"},
    "清洁能源供应链的竞争": {"content": "全球应对气候变化的共识推动了向清洁能源的加速转型，但这也催生了新的地缘经济竞争。竞争的核心集中在清洁能源技术的关键供应链上，包括太阳能光伏板、风力涡轮机、电动汽车电池等。从关键矿产（如锂、钴、稀土）的开采和提炼，到核心部件的制造和组装，再到最终产品的市场份额，各国都在通过产业政策、贸易壁垒和技术投资等手段，力图构建自主可控且具有全球竞争力的清洁能源产业链，这已成为新的国家产业战略焦点。"},
    "传统能源地缘政治的变迁": {"content": "尽管能源转型在加速，但在可预见的未来，石油和天然气等传统化石能源仍在全球能源消费中占据重要地位。然而，其地缘政治格局正在发生深刻变化。美国凭借“页岩革命”从最大的能源进口国转变为重要的出口国，改变了全球油气市场的供需平衡。俄罗斯则试图利用其能源出口作为地缘政治工具。与此同时，中东产油国也在积极推动经济多元化，以应对未来的“后石油时代”。这些变化使得传统能源市场的波动性增加，其地缘政治风险依然不容忽视。"},
    "意识形态与文化叙事的力量": {"content": "在全球格局的重塑过程中，意识形态和文化叙事的竞争正重新成为一个突出特征。一些国家试图以“民主对抗威权”的二元对立框架来划分阵营，构建价值观联盟。与此同时，非西方国家则在积极探索符合自身国情的发展道路和现代化模式，并试图在全球舞台上传播自己的文化理念和治理经验。这种围绕“制度优越性”和“文明先进性”的叙事竞争，通过媒体、教育、文化产品等多种渠道展开，深刻影响着各国民众的相互认知和国家间的软实力对比。"},
    "案例一：亚洲的群体性崛起与内部整合": {"content": "亚洲，特别是东亚和东南亚地区，是当前世界经济增长最具活力的引擎。以中国为龙头，包括东盟、印度、韩国等在内的经济体形成了紧密的区域生产网络。RCEP的签署和生效进一步加速了区域内部的贸易和投资自由化，推动了经济一体化进程。然而，该地区也面临着严峻的挑战，包括主要国家之间的领土争端、历史遗留问题以及大国在该地区的战略博弈。亚洲能否在保持经济活力的同时，成功构建一个包容、稳定的地区安全框架，是其能否在全球格局中扮演更重要角色的关键。"},
    "案例二：欧洲一体化的挑战与韧性": {"content": "作为世界上最成功的区域一体化实践，欧盟在全球格局中扮演着独特的“规范性力量”角色。然而，近年来，欧洲一体化面临着内外多重挑战。内部，英国脱欧、民粹主义兴起、南北成员国经济分化等问题持续发酵。外部，乌克兰危机暴露了其在安全上对美国的依赖，能源危机则凸显了其经济的脆弱性。尽管如此，欧盟在数字治理、气候变化等领域依然是全球规则制定的引领者，并在危机面前展现出了一定的政策协调能力和战略韧性，其未来的走向依然是影响世界格局的重要变量。"},
    "案例三：“全球南方”的诉求与行动": {"content": "“全球南方”国家，即广大的发展中国家和新兴市场国家，在全球格局中的集体意识和行动能力正在显著提升。它们不再满足于被动接受由西方主导的国际秩序和发展模式，而是积极发出自己的声音，要求在全球治理体系中获得更大的代表性和发言权。在气候变化谈判、国际金融机构改革、全球发展倡议等议题上，“全球南方”国家加强协调，共同提出诉求。金砖国家扩员、不结盟运动的再活跃等，都标志着这股力量正在成为重塑世界发展格局不可忽视的重要力量。"},
    "未来格局演变的三种情景推演": {"content": "展望未来，世界发展格局的演变路径充满不确定性。我们可以大致推演三种可能的情景：第一种是“新冷战”情景，即世界分裂为以中美为首的两个相互对立、经济和技术上逐步脱钩的集团。第二种是“碎片化多极”情景，即多个力量中心并存，但缺乏有效的全球协调机制，国际竞争激烈，地区冲突频发，全球性问题难以解决。第三种是“合作性多极”情景，即各主要力量中心能够在承认差异和竞争的同时，围绕共同挑战建立起有效的多边合作框架，共同维护一个相对稳定和开放的国际体系。现实的路径可能介于这三者之间，并动态演变。"},
    "全球治理体系的改革方向": {"content": "现行的全球治理体系，如联合国、世界贸易组织、国际货币基金组织等，是在二战后建立的，已难以完全适应21世纪的现实。其改革的核心方向应是增加新兴市场和发展中国家的代表性和发言权，以更准确地反映全球力量对比的变化。改革的重点领域应包括：改革安理会以增强其权威性和有效性；维护和加强以WTO为核心的多边贸易体制，并使其规则适应数字经济和绿色经济的发展；改革国际金融机构的投票权和治理结构；以及在网络、外空、极地等新疆域建立新的国际规则。"},
    "结论：在不确定性中航行": {"content": "总而言之，我们正处在一个世界发展格局发生深刻而复杂变化的时代。单极时刻已经终结，一个更加多元、竞争也更加激烈的多极化格局正在形成之中。全球化并未消亡，而是在重构；地缘政治竞争正在回归，并与经济、科技等领域的竞争深度捆绑。面对这样一个充满不确定性的未来，所有国家都需要保持高度的战略清醒，既要积极参与竞争与合作，维护自身核心利益，又要秉持开放和包容的心态，致力于推动全球治理体系朝着更加公正合理的方向发展，共同驾驭人类社会这艘航船，在充满风浪的时代中平稳前行。"},
    "default": {"content": "这是一个测试章节。"}
}
MOCK_REFINED_CONTENT = {
    "概念界定与维度解析": {"content": "**世界发展格局**，作为一个核心的地缘政治与国际关系概念，指的是在特定历史时期内，全球范围内主要国家和国际行为体在政治影响力、经济实力、军事部署、科技创新及文化传播等多个维度上的力量分布、相互作用关系以及由此形成的国际秩序与治理模式的总体态势。此格局并非静止不变，而是一个动态演化的系统，其变迁深刻反映了国际力量对比的此消彼长与全球治理体系的适应性调整。"},
    "历史脉络中的格局演变": {"content": "纵观现代史，世界发展格局的演变清晰地勾勒出一条从多极纷争到两极对峙，再到冷战后“一超多强”并最终迈向全面多极化的路径。以威斯特伐利亚体系为起点，欧洲列强主导的多极格局持续了数百年。第二次世界大战后，世界进入了以美苏为核心的壁垒分明的两极格局。随着苏联解体，美国一度成为唯一的超级大国，但21世纪以来，中国的高速发展、欧盟的一体化深化、俄罗斯的战略复苏以及印度等新兴大国的群体性崛起，正强有力地推动世界格局进入一个更加复杂、多元和充满不确定性的新多极化时代。"},
    "研究当前格局的时代意义": {"content": "深入剖析世界发展格局，对于精准理解国际关系的复杂动态、科学制定国家长远战略、并敏锐把握我们所处时代的根本脉搏具有不可替代的理论与实践价值。它不仅直接决定了大国间从合作、竞争到对抗的光谱分布，更深刻地塑造了全球性挑战的应对框架，例如在气候变化治理、全球公共卫生体系构建以及国际经济秩序改革等关键议题上。"},
    "从超级全球化到选择性全球化": {"content": "后冷战时代见证了“超级全球化”的顶峰，其核心特征是基于效率最大化原则的全球生产网络和近乎无摩擦的资本流动。然而，2008年金融海啸揭示了这种模式的系统性风险。如今，我们正步入一个“选择性全球化”的新阶段。在这一阶段，国家安全、产业韧性和价值观联盟成为影响跨国经济活动的关键考量。各国不再追求无限制的开放，而是通过“友岸外包”（friend-shoring）和“近岸外包”（near-shoring）等策略，构建更可控、更具弹性的供应链体系，这预示着一个以地缘政治和战略互信为基础的、更加集团化的全球经济新形态正在形成。"},
    "供应链重构与区域化崛起": {"content": "作为选择性全球化的直接体现，全球供应链正经历一场自二战以来最深刻的结构性重构。企业战略正从单一追求成本效率的“即时生产”（Just-in-Time）模式，转向兼顾风险抵御能力的“以防万一”（Just-in-Case）模式。这一转变极大地推动了生产网络的区域化集聚。以《区域全面经济伙伴关系协定》（RCEP）为代表的亚太经济圈、升级版的《美墨加协定》（USMCA）所强化的北美经济圈，以及欧盟力推的“开放性战略自主”，都在加速形成更加内聚的区域经济板块。这种趋势在提升区域经济韧性的同时，也可能固化集团间的贸易与技术壁垒，对以世界贸易组织（WTO）为核心的多边贸易体制构成长期挑战。"},
    "大国战略竞争的全面化": {"content": "当前世界发展格局最核心的变量，无疑是中美之间日趋激烈、长期化和全面化的战略竞争。这场竞争已远远超越传统的军事安全和贸易摩擦范畴，全面渗透到决定未来国运的各个领域：从5G、人工智能到半导体技术标准的制定权之争；从美元体系的主导地位到数字货币的未来；从网络空间、外太空、深海、极地等新疆域的规则博弈，到全球治理机构的议程设置权。双方都在全球范围内加紧构建和巩固各自的联盟与伙伴关系网络，形成了一场围绕技术、资本、规则和叙事的全方位、多层次博弈，深刻地重塑了全球的政治、经济与安全版图。"},
    "“中间地带”国家的战略自主": {"content": "在大国竞争日益白热化的宏观背景下，广大的“中间地带”国家——涵盖了从欧洲主要国家到东盟、中东、拉美和非洲的关键行为体——其寻求“战略自主”的意愿和能力显著增强。这些国家普遍不愿被动地卷入零和博弈，更不希望成为大国对抗的代理人或牺牲品。它们正积极利用自身独特的地理位置、庞大的市场潜力、丰富的自然资源或在特定领域的技术优势，在多个大国之间采取灵活的对冲和平衡策略，以期实现自身国家利益的最大化。这种多元化的战略选择使得国际关系的网络结构变得空前复杂，也为全球格局的未来演变注入了更多的不确定性和能动性。"},
    "债务周期与货币政策转向": {"content": "全球经济正处于一个历史性的高债务周期的顶峰。在经历了长达十余年的超低利率和大规模量化宽松之后，各国，特别是主要经济体的公共和私人部门债务已累积至前所未有的水平。新冠疫情期间的巨额财政纾困措施更是加剧了这一问题。为遏制四十年来最严重的通货膨胀，美联储等主要央行被迫采取激进的紧缩货币政策，导致全球融资成本飙升。这一转变不仅对众多新兴市场和发展中经济体构成了严峻的主权债务违约风险，也通过抑制投资和消费，对全球经济的持续复苏构成了严重威胁。主要经济体货币政策周期的不同步，还进一步放大了全球资本流动的波动性和金融市场的不稳定性。"},
    "数字鸿沟与财富分配不均": {"content": "数字革命在创造巨大财富的同时，也加剧了全球范围内的不平等问题。首先，国家间的“数字鸿沟”依然触目惊心，发展中国家在数字基础设施、数据资源、技术应用和人才储备方面远远落后于发达国家。其次，在一国内部，城乡之间、不同社会阶层之间的数字接入能力和数字素养差距也在拉大。这种数字不平等与传统的财富分配不均问题相互交织、彼此强化。少数超大型科技平台通过对数据和核心算法的垄断，以前所未有的速度积累财富，形成了新的“数字寡头”，这已成为全球经济学家和社会学家共同关注的、亟待解决的重大治理挑战。"},
    "人工智能与生物技术的战略价值": {"content": "人工智能（AI）与生物技术，作为第四次工业革命的两大核心引擎，其战略价值已远远超出了传统的经济和产业范畴，成为决定国家长期竞争力的关键。在安全领域，AI正通过自主武器系统、智能化指挥控制和认知作战等方式，颠覆传统的战争形态。在经济领域，生成式AI正在重塑知识工作的未来。与此同时，以CRISPR基因编辑、合成生物学和脑机接口为代表的前沿生物技术，不仅对人类健康、农业生产和环境保护至关重要，更潜藏着改变人类自身能力边界的巨大潜力。因此，抢占这两大技术的制高点，已成为所有大国的核心国家战略。"},
    "技术标准与数字治理的博弈": {"content": "随着新兴技术的加速迭代和广泛应用，围绕技术标准和数字治理规则的国际博弈已成为大国竞争的焦点。谁能主导5G/6G、人工智能伦理、物联网协议等关键领域的技术标准制定，谁就能在全球产业链中获得巨大的先发优势和持久的影响力。与此同时，各国在数据跨境流动、个人隐私保护、平台企业监管、网络主权等核心数字治理议题上，提出了截然不同的监管理念和法律框架。例如，欧盟的《通用数据保护条例》（GDPR）强调个人权利，美国的模式更侧重市场自由，而中国则将数据安全置于首位。这场规则之争的本质，是对未来数字世界秩序主导权的争夺。"},
    "清洁能源供应链的竞争": {"content": "全球应对气候变化的政治共识，正催生一场以清洁能源为核心的深刻地缘经济变革。这场变革的竞争焦点，已从传统的油气资源转向覆盖全产业链的清洁能源技术。具体而言，竞争体现在以下几个层面：首先是对上游关键矿产资源的控制，如锂、钴、镍和稀土；其次是中游核心制造能力的比拼，包括太阳能光伏板、风力涡轮机和电动汽车电池的生产；最后是下游终端市场的争夺和相关基础设施的部署。各国正通过巨额产业补贴、贸易保护措施和技术研发投资，力图在这场新的产业革命中构建自主可控且具备全球领导力的供应链体系。"},
    "传统能源地缘政治的变迁": {"content": "尽管能源转型是大势所趋，但在未来数十年内，石油和天然气等传统化石能源仍将在全球能源结构中扮演重要角色。然而，其背后的地缘政治逻辑正在发生根本性变化。美国凭借“页岩革命”从全球最大的能源进口国一跃成为重要的油气出口国，彻底改变了全球市场的供需平衡，削弱了OPEC的定价权。俄罗斯则愈发频繁地将能源供应作为其外交政策的武器。与此同时，以沙特阿拉伯和阿联酋为首的中东主要产油国，正以前所未有的力度推动经济多元化战略，以应对未来的“后石油时代”。这些因素共同导致了传统能源市场的波动性加剧，其地缘政治风险的复杂性不降反升。"},
    "意识形态与文化叙事的力量": {"content": "在全球力量格局发生结构性变迁的当下，意识形态和文化叙事的竞争正重新成为国际关系的一个突出特征。部分西方国家试图重拾冷战时期的“民主对抗威权”二元对立框架，以此为基础构建价值观联盟，巩固其国际地位。与此同时，以中国为代表的众多非西方国家，则在积极探索符合本国国情和文化传统的现代化发展道路，并致力于在全球舞台上推广“人类命运共同体”等不同于西方中心主义的全球治理理念。这场围绕“制度模式优越性”和“文明叙事吸引力”的竞争，通过国际传播、文化交流、教育合作等多种渠道展开，深刻影响着各国民众的相互认知、国家形象的塑造以及全球软实力的分布。"},
    "案例一：亚洲的群体性崛起与内部整合": {"content": "亚洲，特别是东亚和东南亚地区，已无可争议地成为21世纪世界经济增长最具活力的核心引擎。以中国庞大的制造业和市场为中心，包括东盟、印度、日本、韩国在内的主要经济体，通过深度参与和共同塑造，形成了一个全球最复杂、最高效的区域生产网络。2022年生效的《区域全面经济伙伴关系协定》（RCEP），作为全球最大的自由贸易协定，正在制度层面进一步加速该区域内部的贸易、投资和人员流动自由化，推动经济一体化向更高水平迈进。然而，该地区也面临着严峻的内部与外部挑战，包括中美战略博弈的直接冲击、部分国家之间的领土主权争端、以及朝鲜半岛等传统安全热点。亚洲能否在持续释放经济潜力的同时，成功构建一个自主、包容且稳定的地区安全与合作框架，是其能否真正在全球格局中扮演领导性角色的关键所在。"},
    "案例二：欧洲一体化的挑战与韧性": {"content": "作为人类历史上最宏大和最成功的区域一体化实践，欧盟在全球格局中长期扮演着独特的“规范性力量”角色，致力于通过法律、标准和多边主义塑造外部世界。然而，进入21世纪第二个十年以来，欧洲一体化进程遭遇了前所未有的连续冲击。内部层面，英国脱欧的政治地震、持续的难民危机、成员国间（特别是南北之间）的经济分化以及右翼民粹主义的兴起，都在侵蚀着欧盟的团结与效率。外部层面，乌克兰危机彻底暴露了其在硬实力安全上对美国的深度依赖，而随之而来的能源危机则凸显了其经济模式的脆弱性。尽管如此，欧盟在数字治理（如GDPR和《数字市场法》）、气候变化应对（如“绿色新政”）等领域依然是全球规则制定的重要引领者，并在危机面前展现出了一定的政策协调能力和战略韧性。其在追求“开放性战略自主”道路上的探索与挣扎，将是影响未来多极世界形态的重要变量。"},
    "案例三：“全球南方”的诉求与行动": {"content": "“全球南方”，这一涵盖了亚洲、非洲和拉丁美洲广大发展中国家和新兴市场国家的集合概念，在全球格局中的主体意识和集体行动能力正在经历历史性的提升。这些国家不再满足于在由西方主导的国际秩序中扮演被动接受者的角色，而是日益积极地发出自己的声音，要求在全球经济、金融和安全治理体系中获得与其日益增长的实力相匹配的代表性和发言权。在气候变化谈判中要求“共同但有区别的责任”，在国际金融机构改革中呼吁增加投票权，在全球发展议程中提出自身的优先事项，都体现了这一趋势。金砖国家机制的扩员、不结盟运动的再活跃，以及在联合国框架内的协同立场，都标志着“全球南方”正在从一个地理概念转变为一支重塑世界发展格局、不容忽视的政治力量。"},
    "未来格局演变的三种情景推演": {"content": "展望未来，世界发展格局的演变路径充满了深刻的不确定性，但我们可以基于当前的主要驱动力，推演三种具有代表性的可能情景。第一种是“新冷战”或“两极对抗”情景：世界分裂为以中美为核心的两个相互对立、在经济、技术和意识形态上逐步脱钩的集团，全球化被集团化所取代。第二种是“碎片化多极”情景：世界呈现出多个力量中心（如美、中、欧、印、俄等）并存的局面，但缺乏有效的全球协调机制和共同的规则基础，国际竞争激烈，地区冲突频发，全球性问题因无法达成共识而持续恶化。第三种是“合作性多极”情景：尽管竞争依然存在，但各主要力量中心能够在承认彼此差异和核心利益的同时，围绕气候变化、全球公共卫生、核不扩散等共同挑战，建立起有效的多边合作框架，共同维护一个相对稳定和开放的国际体系。现实的路径极有可能是这三种情景的混合体，并在不同议题领域呈现出不同的特征。"},
    "全球治理体系的改革方向": {"content": "当前以联合国为核心的全球治理体系，其基本框架是在二战后确立的，已难以完全适应21世纪全球力量分布的现实和新型全球性挑战的需求。其改革势在必行，核心方向应是提升治理体系的包容性、代表性和有效性。具体而言，改革的重点领域应包括：第一，推动联合国安理会的改革，增加新兴市场和发展中国家的代表性，以增强其决策的合法性和权威性。第二，维护和加强以世界贸易组织（WTO）为核心的多边贸易体制，并对其规则进行现代化升级，以适应数字经济、绿色经济和供应链安全等新议题。第三，改革国际货币基金组织和世界银行的投票权与治理结构，更准确地反映全球经济版图的变化。第四，在网络空间、外太空、人工智能、生物安全等“全球公域”和“新疆域”，加快建立新的国际行为准则和治理机制。"},
    "结论：在不确定性中航行": {"content": "总而言之，我们正处在一个世界发展格局发生深刻、复杂且可能是长期结构性变化的时代。后冷战时代的单极时刻已经终结，一个更加多元、竞争也更加激烈的多极化格局正在加速形成。全球化并未消亡，而是在压力下重构其形态；地缘政治竞争正在回归舞台中心，并与经济、科技等领域的竞争深度捆绑，形成复合式的竞争态势。面对这样一个充满不确定性甚至潜在风险的未来，所有国际行为体都需要保持高度的战略清醒和历史耐心。这既要求各国积极参与竞争与合作，坚定维护自身的核心利益，也要求它们秉持开放和包容的心态，致力于推动全球治理体系朝着更加公正合理的方向发展，共同驾驭人类社会这艘航船，在充满风浪的时代中平稳前行。"},
    "default": {"content": "这是一个经过深度润色和专业化提升的精炼内容。文本在原有基础上增加了更多细节、分析和专业术语，使其更具说服力和学术价值。"}
}

# --- Mock Chat Completions Endpoint ---

class ChatCompletionRequest(BaseModel):
    model: str
    messages: List[Dict[str, Any]]
    stream: bool = False
    max_tokens: Optional[int] = None

async def generate_and_stream_response() -> AsyncGenerator[str, None]:
    """
    An async generator that yields formatted server-sent events.
    """
    text = "This is a local streaming test from the FastAPI mock server using yield. "
    chunks = text.split(" ")
    
    for i, chunk in enumerate(chunks):
        response_chunk = {
            "id": "chatcmpl-mock-yield-123",
            "object": "chat.completion.chunk",
            "created": 1694268190,
            "model": "local-test-model-yield",
            "choices": [
                {
                    "index": 0,
                    "delta": {"content": f"{chunk} "},
                    "finish_reason": None,
                }
            ],
        }
        yield f"data: {json.dumps(response_chunk)}\n\n"
        await asyncio.sleep(0.02)

    yield "data: [DONE]\n\n"

def _normalize_key(key: str) -> str:
    """Normalizes a key for matching by removing prefixes and punctuation."""
    return re.sub(r'[\s.:]', '', key)

@router.post("/chat/completions", summary="Mock Chat Completions")
async def chat_completions(request: ChatCompletionRequest):
    """
    A mock endpoint that simulates OpenAI's chat completions API with streaming.
    It intelligently returns mock data based on the prompt content for the /write agent.
    """
    logger.info(f"Received mock chat completion request for model: {request.model}")
    
    if request.stream:
        return StreamingResponse(generate_and_stream_response(), media_type="text/event-stream")
    
    prompt_content = request.messages[-1].get("content", "")
    mock_response_content = {}
    matched_phase = "None"

    if "generate the elaboration for the goal" in prompt_content.lower():
        matched_phase = "Elaboration"
        mock_response_content = MOCK_ELABORATION
    elif "generate the json outline for the goal" in prompt_content.lower():
        matched_phase = "Outline"
        mock_response_content = MOCK_OUTLINE
    elif "generate the writing strategy for the chapter" in prompt_content.lower():
        matched_phase = "Chapter Strategy"
        for chapter_title, strategy in MOCK_CHAPTER_STRATEGIES.items():
            if f'"{chapter_title}"' in prompt_content:
                mock_response_content = strategy
                break
    elif "write the content for the section" in prompt_content.lower():
        matched_phase = "Section Content"
        match = re.search(r'Current Section to Write:[^"]*"(.*?)"', prompt_content)
        if match:
            section_title_full = match.group(1)
            section_key = section_title_full.split(" ", 1)[-1]
            mock_response_content = MOCK_SECTION_CONTENT.get(section_key, MOCK_SECTION_CONTENT["default"])
        else:
            mock_response_content = MOCK_SECTION_CONTENT["default"]
    elif "refine the original content" in prompt_content.lower():
        matched_phase = "Refinement"
        match = re.search(r'Section Title:[^"]*"(.*?)"', prompt_content)
        if match:
            section_title_full = match.group(1)
            section_key = section_title_full.split(" ", 1)[-1]
            mock_response_content = MOCK_REFINED_CONTENT.get(section_key, MOCK_REFINED_CONTENT["default"])
        else:
            mock_response_content = MOCK_REFINED_CONTENT["default"]
    
    logger.info(f"Mock endpoint matched phase: {matched_phase}")

    if matched_phase != "None":
        return {
            "id": "chatcmpl-mock-agent",
            "object": "chat.completion",
            "created": int(time.time()),
            "model": "local-test-model-agent",
            "choices": [
                {
                    "index": 0,
                    "message": {
                        "role": "assistant",
                        "content": json.dumps(mock_response_content)
                    },
                    "finish_reason": "stop"
                }
            ]
        }

    logger.warning("No specific agent prompt matched. Returning default mock response.")
    return {
        "id": "chatcmpl-mock-nonstream",
        "object": "chat.completion",
        "created": int(time.time()),
        "model": "local-test-model",
        "choices": [
            {
                "index": 0,
                "message": {
                    "role": "assistant",
                    "content": "This is a non-streaming response from the FastAPI mock server.",
                },
                "finish_reason": "stop",
            }
        ],
    }


@router.post("/reset-database", summary="Reset Database for Testing")
def reset_database(conn: sqlite3.Connection = Depends(get_db_connection)):
    """
    Resets the agent-related tables in the database to a clean state.
    This is intended for development and testing purposes only.
    """
    try:
        cursor = conn.cursor()
        cursor.execute("DROP TABLE IF EXISTS agent_task_steps;")
        cursor.execute("DROP TABLE IF EXISTS agent_tasks;")
        conn.commit()
        init_db()
        return {"status": "ok", "message": "Database tables for agents have been reset."}
    except Exception as e:
        return {"status": "error", "message": str(e)}